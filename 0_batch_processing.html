<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.649">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>batch_processing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="0_batch_processing_files/libs/clipboard/clipboard.min.js"></script>
<script src="0_batch_processing_files/libs/quarto-html/quarto.js"></script>
<script src="0_batch_processing_files/libs/quarto-html/popper.min.js"></script>
<script src="0_batch_processing_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="0_batch_processing_files/libs/quarto-html/anchor.min.js"></script>
<link href="0_batch_processing_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="0_batch_processing_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="0_batch_processing_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="0_batch_processing_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="0_batch_processing_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<section id="process-ctd-data-in-r-using-gapctd" class="level1">
<h1>Process CTD data in R using gapctd</h1>
<p>The gapctd package processes CTD data collected during Alaska Fisheries Science Center bottom trawl surveys. The entire data processing workflow is run in R aside from decoding of raw data files in SBE Data Processing Software. The gapctd package uses the <a href="https://dankelley.github.io/oce/">oce package</a> (Kelley et al., 2022) for handling CTD data. Data are processed using R versions of modules from SBE Data Processing software and methods for optimizing module parameters that have been applied to underway CTD and glider data (Garau et al., 2011; Ullman and Hebert, 2014).</p>
<p>The data processing workflow described below was developed for processing data from Sea-Bird SBE19plus V2 CTDs with induction pumps that are deployed on bottom-trawl survey gear in the eastern Bering Sea, Gulf of Alaska, and Aleutian Islands.</p>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">1. Installation</h2>
<p>Install SBE Data Processing software (available from the manufacturer) and the gapctd package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"afsc-gap-products/gapctd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-package-define-global-variables-and-connect-to-oracle" class="level2">
<h2 class="anchored" data-anchor-id="load-package-define-global-variables-and-connect-to-oracle">2. Load package, define global variables, and connect to Oracle</h2>
<p>Load the <code>gapctd</code> package. Assign vessel, cruise, and region (BS, GOA, or AI) variables and set the source directory where CTD hex files and .xmlcon file are stored.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gapctd)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Select vessel, cruise, and region</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>vessel <span class="ot">&lt;-</span> <span class="dv">94</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>cruise <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">202101</span>, <span class="dv">202202</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>region <span class="ot">&lt;-</span> <span class="st">"BS"</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>ctd_dir <span class="ot">&lt;-</span> <span class="st">"G:/RACE_CTD/data/2021/ebs/v94_ctd1"</span> <span class="co"># Directory w/ CTD data (.hex) and config (.xmlcon)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>processing_method <span class="ot">&lt;-</span> <span class="st">"gapctd"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setup-directory-for-processing" class="level2">
<h2 class="anchored" data-anchor-id="setup-directory-for-processing">3. Setup directory for processing</h2>
<p>The <code>setup_gapctd_directory</code> function sets up the working directory for processing data from a single CTD, vessel, and cruise. Raw CTD data files (.hex) and configuration files (.xmlcon) are copied from the source directory, ctd_dir, to the /data/ and /psa_xmlcon/ directories. Then, the SBE Data Processing DatCnv module is run using system commands to convert .hex files to human-readable decoded CTD data files (.cnv) that get saved in the /cnv/ directory.</p>
<p><em>Note: A new directory/project will need to setup for each cruise/vessel/CTD combination.</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">setup_gapctd_directory</span>(<span class="at">processing_method =</span> processing_method, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">ctd_dir =</span> ctd_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/1_setup_directory.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Left: SBE Data Processing converting raw data files after calling the setup_gapctd_directory(). Right: Contents of the working directory after successfully running setup_gapctd_directory().</figcaption><p></p>
</figure>
</div>
</section>
<section id="retrieve-haul-data-from-racebase" class="level2">
<h2 class="anchored" data-anchor-id="retrieve-haul-data-from-racebase">4. Retrieve haul data from RACEBASE</h2>
<p>The <code>get_haul_data</code> function retrieves haul data for a vessel/cruise from RACEBASE and writes the haul data to an R data file ( /output/HAUL_DATA_[vessel]_[cruise].rds).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish Oracle connection connection</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>channel <span class="ot">&lt;-</span> gapctd<span class="sc">::</span><span class="fu">get_connected</span>(<span class="at">schema =</span> <span class="st">"AFSC"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get haul data from RACEBASE and write to an .rds file in /output/</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>haul_df <span class="ot">&lt;-</span> gapctd<span class="sc">:::</span><span class="fu">get_haul_data</span>(<span class="at">channel =</span> channel,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">vessel =</span> vessel,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">cruise =</span> cruise,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">tzone =</span> <span class="st">"America/Anchorage"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load haul data</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>haul_df <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">paste0</span>(<span class="st">"HAUL_DATA_"</span>, vessel, <span class="st">"_"</span>, <span class="fu">paste</span>(cruise, <span class="at">collapse =</span> <span class="st">"_"</span>), <span class="st">".rds"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The tzone = “America/Anchorage” argument specifies the timezone to use for haul event times in RACEBASE that are stored in UTC.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/4_get_haul_data.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Contents of the /output/ directory after running get_haul_data(), showing the haul data file (HAUL_DATA_94_202101_202102.rds).</figcaption><p></p>
</figure>
</div>
</section>
<section id="run-gapctd-processing-methods-on-ctd-files" class="level2">
<h2 class="anchored" data-anchor-id="run-gapctd-processing-methods-on-ctd-files">5. Run gapctd processing methods on CTD files</h2>
<p>The <code>wrapper_run_gapctd</code> function implements the <code>run_gapctd</code> function on each CTD file in the working directory. The <code>run_gapctd</code> function processes data for a single CTD data file (.cnv) using the <a href="./doc/batch_processing_steps.md">processing steps</a> we have found works best for our deployments across bottom trawl survey regions.</p>
<p><em>Note: wrapper_run_gapctd takes 8+ hours to run for a full vessel/cruise.</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run data processing algorithm on files. Write .rds</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">wrapper_run_gapctd</span>(<span class="at">cnv_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"cnv"</span>), <span class="co"># Path to decoded CTD data (.cnv) files</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">processing_method =</span> processing_method, <span class="co"># Processing method</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">haul_df =</span> haul_df) <span class="co"># Haul data from step 4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Outputs from <code>wrapper_run_gapctd</code> are stored in oce objects that are saved in R data (.rds) files in /output/gapctd/ <a href="./doc/ctd_data_files.md">(example)</a>. The files include three segments for each deployment (downcast, bottom, upcast). Haul metadata are included with each of the segments. If any segment is missing, it will not be included in the file (i.e., if the CTD shut-off during the deployment and there is no upcast data, there will not be an upcast file in the object).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/5_run_gapctd.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Top: Console messages while running wrapper_run_gapctd(). Bottom: Contents of the /output/gapctd/ directory after successfully running wrapper_run_gapctd().</figcaption><p></p>
</figure>
</div>
</section>
<section id="make-metadata-file" class="level2">
<h2 class="anchored" data-anchor-id="make-metadata-file">6. Make metadata file</h2>
<p>The <code>make_metadata_file</code> function reads in R data (.rds) files from each casts, calculates haul-level averages from bottom samples (i.e., mean bottom salinity, mean bottom temperature), and retrieves other metadata that are included in the data product. The data are then written to the file path specified using the output_path argument. This is the last time bottom data will be used in processing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make metadata and bottom averages file</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">make_metadata_file</span>(<span class="at">rds_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, <span class="st">"gapctd"</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">in_pattern =</span> <span class="st">"_raw.rds"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">output_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"metadata"</span>, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                                                     <span class="fu">paste0</span>(<span class="st">"CTD_HAUL_DATA_"</span>, vessel, <span class="st">"_"</span>, <span class="fu">paste</span>(cruise, <span class="at">collapse =</span> <span class="st">"_"</span>), <span class="st">".rds"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/6_make_metadata_file.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Contents of the /metadata/ directory after running make_metadata_file(), showing the metadata file (CTD_HAUL_DATA_94_202101_202202.rds)</figcaption><p></p>
</figure>
</div>
</section>
<section id="run-basic-data-quality-checks" class="level2">
<h2 class="anchored" data-anchor-id="run-basic-data-quality-checks">7. Run basic data quality checks</h2>
<p>The <code>move_bad_rds</code> function checks data files from each deployment for common errors in downcast and upcast profiles. Files with bad upcasts or downcasts are moved to /bad_cnv/ while good casts are retained in the /output/gapctd/ directory. If only one of the casts from a deployment fails data quality checks, the good profile is retained in the /output/gapctd directory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Move 'bad' files to bad_cnv</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">move_bad_rds</span>(<span class="at">rds_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, processing_method))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>![<img src="./doc/assets/r_process/7_move_bad_rds.png" class="img-fluid" alt="Contents of the /bad_cnv/ directory after running move_bad_rds()"></p>
</section>
<section id="visually-inspect-flag-and-interpolate-bad-data-first-round" class="level2">
<h2 class="anchored" data-anchor-id="visually-inspect-flag-and-interpolate-bad-data-first-round">8. Visually inspect, flag, and interpolate bad data (first round)</h2>
<p><em>IMPORTANT: For this step, your display/GUI must be set to Actual Size in R Studio! Use the drop down menu (View &gt; Actual Size) to set your R Studio display to Actual Size</em></p>
<p>There are often dynamic errors in profiles after the automated processing steps that typically appear as large salinity spikes. The <code>qc_flag_interpolate</code> function provides a graphical user interface that allows users to inspect plots of profile data for selected data and select erroneous data that should be removed and interpolated. The <code>wrapper_flag_interpolate</code> function is a wrapper for <code>qc_flag_interpolate</code>.</p>
<p>Please note that interpolation can sometimes behave in unintuitive ways when interpolating salinity and density because the function interpolates conductivity and temperature, not salinity and density. Salinity and density are recalculated after interpolating conductivity and temperature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visually inspect, flag, and interpolate</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">wrapper_flag_interpolate</span>(<span class="at">rds_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, processing_method),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">review =</span> <span class="fu">c</span>(<span class="st">"density"</span>, <span class="st">"salinity"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are two sets of plots to review for every cast. Set #1 shows temperature, salinity, and density profiles. Set #2 shows the rate of change in salinity and salinity.</p>
<p><em>The goal of this step is to flag large transient errors. Pay careful attention to the range on the x-axis when assessing the magnitude of spikes in the data.</em> Flags should not be applied to small errors and/or errors that persist for multiple consecutive depth bins. Correcting small and persistent errors is unnecessary because the other cast from a deployment is often suitable or subsequent corrections may resolve the errors.</p>
<section id="set-1" class="level4">
<h4 class="anchored" data-anchor-id="set-1">Set 1</h4>
<ol type="1">
<li>Review the right panel for density errors.</li>
<li>Left-click on any points in the right panel (density) that should be removed and interpolated. Do not select the points if there are errors in salinity that do not produce large errors in density.</li>
<li>Press Esc. If any points were selected, conductivity and temperature for the selected pressure bin will be removed and salinity and pressure will be recalculated.</li>
<li>Repeat 1-3 until there are no more errors to remove.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/8_flag_interpolate_3.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Set 1 plots: Pressure versus temperature (left), salinity (center), and density (right).</figcaption><p></p>
</figure>
</div>
</section>
<section id="set-2" class="level4">
<h4 class="anchored" data-anchor-id="set-2">Set 2</h4>
<ol type="1">
<li>Review the panels for salinity errors.</li>
<li>Left-click on any points in the left panel (salinity) that should be removed and interpolated.</li>
<li>Press Esc. If any points were selected, conductivity and temperature for the selected pressure bin will be removed and salinity and pressure will be recalculated.</li>
<li>Repeat 1-3 until there are no more errors to remove.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/8_flag_interpolate_4.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Set 2 plots: Rate of change in salinity (left) and salinity (right)</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/8_flag_interpolate.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Selecting and interpolating the shallowest density bin, showing set 1 profiles before (top) and after (bottom).</figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="select-profiles-to-include-in-data-product-first-round" class="level2">
<h2 class="anchored" data-anchor-id="select-profiles-to-include-in-data-product-first-round">9. Select profiles to include in data product (first round)</h2>
<p>The <code>review_profiles</code> function provides an interface for visually inspecting profiles for each deployment and selecting the profiles to include in the final data product. The goal of this step is to select the profile(s) without dynamic errors (e.g., unreasonable salinity spikes or density inversions).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review profiles</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">review_profiles</span>(<span class="at">rds_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, processing_method),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">threshold =</span> <span class="sc">-</span><span class="fl">1e-5</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">in_pattern =</span> <span class="st">"_qc.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Data from each deployment are displayed one at a time. If a downcast and upcast are both available, both will be shown simultaneously. If only one cast is available, only the downcast or upcast will be shown.</p>
<p>Follow instructions in the console to select profiles to use in the final data product: both casts (1), downcast (d), upcast (u), or none (0). If both casts are available from a deployment but none are selected, data from the cast will be reprocessed using a different approach to conductivity cell thermal mass correction and profiles will be reviewed again after processing.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/9_review_profiles.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Plots: Downcast (top row of profile plots) and upcast (bottom row of profile plots). Left-side panels show temperature (red) and salinity (green) versus depth. Right-side panel show density anomaly (blue) and buoyancy frequency (brown) versus depth. A vertical line on the right panels shows the buoyancy frequency threshold below which the density structure of the water column could be considered unstable. R Console output: User interface for selecting casts.</figcaption><p></p>
</figure>
</div>
</section>
<section id="remedial-corrections-for-conductivity-cell-thermal-intertia-errors" class="level2">
<h2 class="anchored" data-anchor-id="remedial-corrections-for-conductivity-cell-thermal-intertia-errors">10. Remedial corrections for conductivity cell thermal intertia errors</h2>
<p>During this step, use the <code>remedial_ctm</code> to select deployments that should be reprocessed using the alternative method for conductivity cell thermal inertia error correction. Casts for each deployment are displayed sequentially. Use the console to select deployments that should be reprocessed (usually all casts).</p>
<p>In the alternative methods, conductivity cell thermal inertia parameters are estimated for individual casts by minimizing the path distance of the salinity curve instead of the primary method of estimating parameters for both casts by minimizing the area between upcast and downcast temperature-salinity curves.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine rejected profiles and run cell thermal mass corrections with alternate values using split_ctm()</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">remedial_ctm</span>(<span class="at">rds_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, processing_method),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">haul_df =</span> haul_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/10_remedial_ctm.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">R console user interface for choosing casts for alternative conductivity cell thermal intertia correction.</figcaption><p></p>
</figure>
</div>
</section>
<section id="visually-inspect-flag-and-interpolate-bad-data-first-round-1" class="level2">
<h2 class="anchored" data-anchor-id="visually-inspect-flag-and-interpolate-bad-data-first-round-1">11. Visually inspect, flag, and interpolate bad data (first round)</h2>
<p>Same as step #8 but profiles are only reviewed if a profile from the deployment was not already selected for inclusion in the final data product.</p>
<p><em>Note: </em> Outside of the program, keep track of which cast (downcast or upcast) should be used in the data product. Keeping track of this is important because profiles will be reviewed one at a time during the next step. File IDs for deployments are displayed as messages in the console.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">##---- Second round of review</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Visually inspect, flag, and interpolate</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">wrapper_flag_interpolate</span>(<span class="at">rds_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, processing_method),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">review =</span> <span class="fu">c</span>(<span class="st">"density"</span>, <span class="st">"salinity"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="select-profiles-to-include-in-data-product-first-round-1" class="level2">
<h2 class="anchored" data-anchor-id="select-profiles-to-include-in-data-product-first-round-1">12. Select profiles to include in data product (first round)</h2>
<p>Same as step #9 except downcast and upcast data are displayed one at a time even if both casts are available from a deployment. If the downcast is selected, the upcast will not be reviewed. If no casts from a deployment are accepted, data from the deployment will not be included in the final data product.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review profiles</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>gapctd<span class="sc">:::</span><span class="fu">review_profiles</span>(<span class="at">rds_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, processing_method),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">threshold =</span> <span class="sc">-</span><span class="fl">1e-5</span>, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">in_pattern =</span> <span class="st">"_qc.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="finalize-data" class="level2">
<h2 class="anchored" data-anchor-id="finalize-data">13. Finalize data</h2>
<p>Move all of the accepted profiles from /output/gapctd/ to the /final_cnv/ directory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">finalize_data</span>(<span class="at">rds_dir_path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"output"</span>, processing_method))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./doc/assets/r_process/13_finalize_data.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Final profile data in the /final_cnv/ directory.</figcaption><p></p>
</figure>
</div>
</section>
<section id="prepare-the-data-product" class="level2">
<h2 class="anchored" data-anchor-id="prepare-the-data-product">14. Prepare the data product</h2>
<p><a href="./doc/prepare_data_product.md">Prepare the data product</a> if all data from the survey have been processed and are in different directories.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>Garau, B., Ruiz, S., Zhang, W. G., Pascual, A., Heslop, E., Kerfoot, J., &amp; Tintoré, J. (2011). Thermal lag correction on slocum CTD glider data. Journal of Atmospheric and Oceanic Technology, 28(9), 1065–1071. <a href="https://doi.org/10.1175/JTECH-D-10-05030.1">https://doi.org/10.1175/JTECH-D-10-05030.1</a></p>
<p>Kelley, D. E., Richards, C., &amp; Layton, C. (2022). oce: an R package for Oceanographic Analysis. Journal of Open Source Software, 7(71), 3594. <a href="https://doi.org/10.21105/joss.03594">https://doi.org/10.21105/joss.03594</a></p>
<p>Ullman, D. S., &amp; Hebert, D. (2014). Processing of underway CTD data. Journal of Atmospheric and Oceanic Technology, 31(4), 984–998. <a href="https://doi.org/10.1175/JTECH-D-13-00200.1">https://doi.org/10.1175/JTECH-D-13-00200.1</a></p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>